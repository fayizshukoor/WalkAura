<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<main class="flex-grow pt-24 pb-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
      
      <nav class="flex text-[10px] sm:text-xs text-gray-500 mb-6 space-x-2 uppercase tracking-[0.2em]">
        <a href="/cart" class="hover:text-primary transition-colors">Cart</a>
        <span>/</span>
        <span class="text-white font-bold">Checkout</span>
        <span>/</span>
        <span class="opacity-30">Confirmation</span>
      </nav>
  
      <h1 class="text-3xl sm:text-4xl font-black mb-10 tracking-tighter uppercase text-white">Checkout</h1>
  
      <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
        
        <div class="xl:col-span-8 space-y-8">
          
          <section class="bg-[#12141a] border border-white/10 rounded-[2rem] overflow-hidden shadow-xl">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/[0.03]">
              <h2 class="text-sm font-extrabold uppercase tracking-widest flex items-center gap-3">
                <span class="material-symbols-outlined text-primary">shopping_bag</span>
                Your Selection
              </h2>
              <span class="text-xs font-bold text-white bg-primary/20 border border-primary/30 px-3 py-1 rounded-full">
                <%= checkout.items.length %> Items
              </span>
            </div>
            <div class="p-6 divide-y divide-white/5">
              <% checkout.items.forEach(item => { %>
                <div class="flex flex-col sm:flex-row gap-6 items-center py-4 first:pt-0 last:pb-0">
                  <div class="w-24 h-24 rounded-2xl overflow-hidden bg-black border border-white/10 flex-shrink-0">
                    <img src="<%= item.image %>" alt="<%= item.productName %>" class="w-full h-full object-contain p-2">
                  </div>
                  <div class="flex-1 text-center sm:text-left">
                    <h3 class="font-bold text-lg text-white"><%= item.productName %></h3>
                    <p class="text-[10px] text-gray-400 uppercase font-black tracking-widest mt-1">
                      Size: <%= item.size %> <span class="mx-2 text-white/10">|</span> 
                      Color: <%= item.color %> <span class="mx-2 text-white/10">|</span> 
                      QTY: <%= item.quantity %>
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="font-black text-xl text-white">₹<%= item.itemTotal.toLocaleString() %></p>
                    <p class="text-[10px] text-gray-500 font-bold tracking-widest uppercase">₹<%= item.price %> per unit</p>
                  </div>
                </div>
              <% }) %>
            </div>
          </section>
  
          <section class="bg-[#12141a] border border-white/10 rounded-[2rem] overflow-hidden shadow-xl">
            <div class="p-6 border-b border-white/10 bg-white/[0.03]">
              <h2 class="text-sm font-extrabold uppercase tracking-widest flex items-center gap-3">
                <span class="material-symbols-outlined text-primary">location_on</span>
                Shipping Details
              </h2>
            </div>
            
            <div class="p-6">
              <% if (checkout.addresses && checkout.addresses.length > 0) { %>
                <div class="space-y-4 mb-10">
                  <% checkout.addresses.forEach((addr, index) => { %>
                    <label class="relative flex items-start p-6 bg-white/[0.02] border border-white/5 rounded-2xl cursor-pointer group hover:border-primary/40 transition-all has-[:checked]:bg-primary/5 has-[:checked]:border-primary/40">
                      <input type="radio" name="selectedAddress" value="<%= addr._id %>" class="mt-1 w-4 h-4 text-primary focus:ring-0 bg-transparent border-white/30" <%= index === 0 ? 'checked' : '' %>>
                      <div class="ml-4 flex-1">
                        <div class="flex items-center gap-3">
                          <p class="font-bold text-lg text-white"><%= addr.fullName %></p>
                        
                        </div>
                        <p class="text-gray-300 text-sm mt-1 font-medium"><%= addr.phone %></p>
                        <p class="text-gray-400 text-sm leading-relaxed mt-2 max-w-md italic">
                          <%= addr.streetAddress %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %>
                        </p>
                      </div>

                      <button type="button" onclick='openEditModal(<%= JSON.stringify(addr) %>)' class="text-primary text-[10px] font-black uppercase tracking-widest hover:text-white transition-colors">Edit</button>

                    </label>
                  <% }) %>
                </div>
              <% } %>
  
              <div class="pt-2">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-gray-400 mb-8 flex items-center gap-4">
                    Or Add New Address
                    <span class="h-px flex-grow bg-white/10"></span>
                </h3>
                <form id="addressForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest ml-1">Full Name</label>
                        <input type="text" name="fullName" placeholder="e.g. John Doe" class="w-full bg-black border-white/10 rounded-xl focus:ring-primary focus:border-primary py-3.5 px-4 text-sm text-white shadow-inner">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest ml-1">Phone Number</label>
                        <input type="text" name="phone" placeholder="+91" class="w-full bg-black border-white/10 rounded-xl focus:ring-primary focus:border-primary py-3.5 px-4 text-sm text-white shadow-inner">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:col-span-2">
                        <div class="space-y-2">
                            <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest ml-1">PIN Code</label>
                            <div class="relative">
                                <input type="text" name="pincode" id="pincodeInput" maxlength="6" class="w-full bg-black border-white/10 rounded-xl focus:ring-primary focus:border-primary py-3 px-4 text-sm text-white shadow-inner">
                                <div id="pincodeLoader" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                                    <div class="animate-spin h-4 w-4 border-2 border-primary border-t-transparent rounded-full"></div>
                                </div>
                            </div>
                            <p id="pincodeError" class="text-[9px] text-red-500 font-bold uppercase hidden">Invalid Pincode</p>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest ml-1 italic opacity-60">City (Auto)</label>
                            <input type="text" name="city" id="cityInput" readonly class="w-full bg-white/[0.02] border-white/5 rounded-xl py-3 px-4 text-sm text-gray-400 cursor-not-allowed outline-none font-medium">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest ml-1 italic opacity-60">State (Auto)</label>
                            <input type="text" name="state" id="stateInput" readonly class="w-full bg-white/[0.02] border-white/5 rounded-xl py-3 px-4 text-sm text-gray-400 cursor-not-allowed outline-none font-medium">
                        </div>
                    </div>

                    <div class="md:col-span-2 space-y-2">
                        <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest ml-1">Street Address</label>
                        <input type="text" name="streetAddress" placeholder="House no, Street name..." class="w-full bg-black border-white/10 rounded-xl focus:ring-primary focus:border-primary py-3.5 px-4 text-sm text-white shadow-inner">
                    </div>
                    
                    <div class="md:col-span-2 flex pt-6">
                        <button type="submit" class="bg-primary hover:bg-indigo-600 text-white px-10 py-4 rounded-2xl font-black uppercase tracking-widest text-xs transition-all shadow-xl shadow-primary/40 active:scale-95">Add Address</button>
                    </div>
                </form>
            </div>

            </div>
          </section>
        </div>
  
        <aside class="xl:col-span-4 space-y-8 lg:sticky lg:top-24">
          <div class="bg-[#12141a] border border-white/10 rounded-[2.5rem] overflow-hidden shadow-2xl relative">
            <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 blur-3xl -mr-16 -mt-16 rounded-full"></div>
  
            <div class="p-8 border-b border-white/10 bg-white/[0.03]">
              <h2 class="text-sm font-black uppercase tracking-[0.2em] flex items-center gap-3">
                <span class="material-symbols-outlined text-primary">receipt_long</span>
                Order Summary
              </h2>
            </div>
  
            <div class="p-8">
              <div class="mb-10">
                <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest mb-4 ml-1">Apply Coupon</label>
                <div class="flex gap-2">
                  <input type="text" id="couponCode" placeholder="Enter code" class="flex-1 bg-black border-white/10 rounded-2xl px-5 py-4 text-sm focus:ring-primary focus:border-primary transition-all uppercase font-bold tracking-widest placeholder:normal-case placeholder:font-normal text-white shadow-inner">
                  <button onclick="applyCoupon()" class="bg-white text-black hover:bg-primary hover:text-white px-6 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-lg">Apply</button>
                </div>
              </div>
  
              <div class="space-y-4 mb-10">
                <div class="flex justify-between items-center text-sm font-medium">
                  <span class="text-gray-400">Subtotal</span>
                  <span class="text-white">₹<%= checkout.pricing.subtotal.toLocaleString() %></span>
                </div>
                <div class="flex justify-between items-center text-sm font-medium">
                  <span class="text-gray-400">Tax (GST 18%)</span>
                  <span class="text-white">₹<%= checkout.pricing.tax.toLocaleString() %></span>
                </div>
                <div class="flex justify-between items-center text-sm font-medium">
                  <span class="text-gray-400">Standard Delivery</span>
                  <% if(checkout.pricing.shippingCharge === 0) { %>
                      <span class="font-black text-green-500 uppercase text-[9px] bg-green-500/10 px-2 py-1 rounded-md">Free</span>
                  <% } else { %>
                      <span class="text-white">₹<%= checkout.pricing.shippingCharge %></span>
                  <% } %>
                </div>
                <div class="flex justify-between items-center text-sm font-bold pt-2">
                  <span class="text-gray-400">Coupon Discount</span>
                  <span class="text-green-500 font-black">- ₹<%= checkout.pricing.discount.toLocaleString() %></span>
                </div>
                
                <div class="pt-6 border-t border-white/10 mt-6">
                  <div class="flex justify-between items-end">
                    <div>
                      <span class="text-[10px] font-black uppercase tracking-[0.2em] text-primary block mb-1">Total Payable</span>
                      <span class="text-3xl font-black text-white tracking-tighter" id="totalAmountDisplay">₹<%= checkout.pricing.totalAmount.toLocaleString() %></span>
                    </div>
                    <span class="material-symbols-outlined text-primary mb-2">payments</span>
                  </div>
                </div>
              </div>
  
              <div class="space-y-3 mb-10">
                <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-6 flex items-center gap-3">
                  Secure Payment
                  <span class="h-px flex-grow bg-white/10"></span>
                </h3>
                
                <div class="grid grid-cols-1 gap-3">
                    <label class="relative flex items-center p-4 bg-black/40 border border-white/5 rounded-2xl cursor-pointer hover:border-primary/50 group transition-all has-[:checked]:border-primary/50 has-[:checked]:bg-primary/[0.02]">
                      <input type="radio" name="paymentMethod" value="razorpay" class="w-4 h-4 text-primary focus:ring-0 bg-transparent border-white/30" checked>
                      <div class="ml-4 flex items-center gap-3">
                          <span class="material-symbols-outlined text-gray-500 group-hover:text-primary transition-colors">bolt</span>
                          <span class="text-sm font-bold text-white">RazorPay</span>
                      </div>
                    </label>
  
                    <label class="relative flex items-center p-4 bg-black/40 border border-white/5 rounded-2xl cursor-pointer hover:border-primary/50 group transition-all has-[:checked]:border-primary/50 has-[:checked]:bg-primary/[0.02]">
                      <input type="radio" name="paymentMethod" value="wallet" class="w-4 h-4 text-primary focus:ring-0 bg-transparent border-white/30">
                      <div class="ml-4 flex flex-col">
                          <div class="flex items-center gap-3">
                              <span class="material-symbols-outlined text-gray-500 group-hover:text-primary transition-colors">account_balance_wallet</span>
                              <span class="text-sm font-bold text-white">Digital Wallet</span>
                          </div>
                          <span class="text-[9px] text-primary font-black uppercase mt-1 tracking-widest ml-9">Instant & Secure</span>
                      </div>
                    </label>
  
                    <label class="relative flex items-center p-4 bg-black/40 border border-white/5 rounded-2xl cursor-pointer hover:border-primary/50 group transition-all has-[:checked]:border-primary/50 has-[:checked]:bg-primary/[0.02]">
                      <input type="radio" name="paymentMethod" value="COD" class="w-4 h-4 text-primary focus:ring-0 bg-transparent border-white/30">
                      <div class="ml-4 flex items-center gap-3">
                          <span class="material-symbols-outlined text-gray-500 group-hover:text-primary transition-colors">local_atm</span>
                          <span class="text-sm font-bold text-white">Cash on Delivery</span>
                      </div>
                    </label>
                </div>
              </div>
  
              <button onclick="handlePlaceOrder()" class="w-full bg-primary hover:bg-indigo-600 text-white font-black uppercase tracking-[0.2em] text-xs py-5 rounded-2xl shadow-2xl shadow-primary/40 transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                Place Order
                <span class="material-symbols-outlined text-sm">arrow_forward_ios</span>
              </button>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <div id="editAddressModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
      <div class="bg-[#12141a] border border-white/10 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
          <div class="p-8 border-b border-white/10 flex justify-between items-center bg-white/[0.03]">
              <h2 class="text-sm font-black uppercase tracking-widest text-white">Edit Shipping Address</h2>
              <button onclick="closeEditModal()" class="text-gray-500 hover:text-white transition-colors">
                  <span class="material-symbols-outlined">close</span>
              </button>
          </div>
          <form id="editAddressForm" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
              <input type="hidden" name="addressId" id="editAddressId">
              <div class="md:col-span-1 space-y-2">
                  <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest">Full Name</label>
                  <input type="text" name="fullName" id="editFullName" class="w-full bg-black border-white/10 rounded-xl py-3.5 px-4 text-sm text-white focus:ring-primary focus:border-primary">
              </div>
              <div class="md:col-span-1 space-y-2">
                  <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest">Phone</label>
                  <input type="text" name="phone" id="editPhone" class="w-full bg-black border-white/10 rounded-xl py-3.5 px-4 text-sm text-white focus:ring-primary">
              </div>

              <div class="grid grid-cols-3 gap-4 md:col-span-2">
                  <div class="space-y-2">
                      <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest">Pincode</label>
                      <input type="text" name="pincode" id="editPincode" maxlength="6" class="w-full bg-black border-white/10 rounded-xl py-3 px-4 text-sm text-white focus:ring-primary">
                  </div>
                  <div class="space-y-2">
                      <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest italic opacity-60">City</label>
                      <input type="text" name="city" id="editCity" readonly class="w-full bg-white/[0.02] border-white/5 rounded-xl py-3 px-4 text-sm text-gray-400">
                  </div>
                  <div class="space-y-2">
                      <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest italic opacity-60">State</label>
                      <input type="text" name="state" id="editState" readonly class="w-full bg-white/[0.02] border-white/5 rounded-xl py-3 px-4 text-sm text-gray-400">
                  </div>
              </div>

              <div class="md:col-span-2 space-y-2">
                  <label class="block text-[10px] font-black text-gray-300 uppercase tracking-widest">Street Address</label>
                  <input type="text" name="streetAddress" id="editStreetAddress" class="w-full bg-black border-white/10 rounded-xl py-3.5 px-4 text-sm text-white focus:ring-primary">
              </div>

              <div class="md:col-span-2 flex justify-end gap-4 pt-4">
                  <button type="button" onclick="closeEditModal()" class="px-8 py-3 rounded-xl font-bold uppercase text-[10px] text-gray-400 hover:text-white transition-colors">Cancel</button>
                  <button type="submit" class="bg-primary hover:bg-indigo-600 text-white px-8 py-3 rounded-xl font-black uppercase tracking-widest text-[10px] transition-all">Save Changes</button>
              </div>
          </form>
      </div>
  </div>

  </main>
  
  <script>
    /**
     * GLOBAL SWEETALERT HELPER
     * Theme-matched to your dark UI
     */
    function showSwal(title, text, icon = 'success', shouldReload = false) {
        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            background: '#12141a',
            color: '#ffffff',
            confirmButtonColor: '#4f46e5',
            confirmButtonText: 'OK',
            customClass: {
                popup: 'rounded-[2rem] border border-white/10 shadow-2xl',
                title: 'text-sm font-black uppercase tracking-widest',
                confirmButton: 'rounded-xl px-8 py-3 font-bold uppercase text-[10px]'
            }
        }).then((result) => {
            if (shouldReload && result.isConfirmed) {
                window.location.reload();
            }
        });
    }

    /**
     * PINCODE VALIDATION & AUTOFILL
     */
    async function handlePincode(pincode, cityInputId, stateInputId, loaderId, errorId) {
        const cityInp = document.getElementById(cityInputId);
        const stateInp = document.getElementById(stateInputId);
        const loader = document.getElementById(loaderId);
        const error = document.getElementById(errorId);

        // CLEAR LOGIC: Clear fields if input is modified/deleted
        if (pincode.length < 6) {
            cityInp.value = "";
            stateInp.value = "";
            if(error) error.classList.add('hidden');
            return;
        }

        if (pincode.length === 6) {
            if(loader) loader.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                const data = await response.json();
                
                if (data[0].Status === "Success") {
                    const details = data[0].PostOffice[0];
                    cityInp.value = details.District;
                    stateInp.value = details.State;
                    if(error) error.classList.add('hidden');
                } else {
                    throw new Error();
                }
            } catch (err) {
                cityInp.value = "";
                stateInp.value = "";
                if(error) error.classList.remove('hidden');
                showSwal("Error", "Invalid Pincode", "error");
            } finally {
                if(loader) loader.classList.add('hidden');
            }
        }
    }

    // Event Listeners for Pincode
    document.getElementById('pincodeInput').addEventListener('input', (e) => 
        handlePincode(e.target.value, 'cityInput', 'stateInput', 'pincodeLoader', 'pincodeError'));
    
    document.getElementById('editPincode').addEventListener('input', (e) => 
        handlePincode(e.target.value, 'editCity', 'editState', null, null));

    /**
     * MODAL CONTROLS
     */
    function openEditModal(addr) {
        document.getElementById('editAddressId').value = addr._id;
        document.getElementById('editFullName').value = addr.fullName;
        document.getElementById('editPhone').value = addr.phone;
        document.getElementById('editPincode').value = addr.pincode;
        document.getElementById('editStreetAddress').value = addr.streetAddress;
        document.getElementById('editCity').value = addr.city;
        document.getElementById('editState').value = addr.state;
        
        document.getElementById('editAddressModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('editAddressModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    /**
     * API FORM SUBMISSIONS
     */
    
    // ADD ADDRESS
    document.getElementById('addressForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);

        const orderedData = {
            fullName: f.get('fullName'),
            phone: f.get('phone'),
            pincode: f.get('pincode'),
            streetAddress: f.get('streetAddress'),
            city: f.get('city'),
            state: f.get('state')
        };
        
        if(!orderedData.city || !orderedData.state) {
            showSwal("Warning", "Please enter a valid pincode to auto-fill location", "warning");
            return;
        }

        try {
            const response = await fetch('/addresses/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderedData)
            });

            const result = await response.json();
            if (response.ok) {
                showSwal("Success", `${result.message}`, "success", true);
            } else {
                showSwal("Error", `${result.message}`, "error");
            }
        } catch (err) {
            showSwal("Error", "Network error occurred", "error");
        }
    });

    // EDIT ADDRESS
    document.getElementById('editAddressForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const addressId = f.get('addressId');

        const orderedData = {
            fullName: f.get('fullName'),
            phone: f.get('phone'),
            pincode: f.get('pincode'),
            streetAddress: f.get('streetAddress'),
            city: f.get('city'),
            state: f.get('state')
        };
        
        if (!orderedData.city || !orderedData.state) {
            showSwal("Warning", "Please enter a valid location", "warning");
            return;
        }

        try {
            const response = await fetch(`/addresses/${addressId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderedData)
            });

            const result = await response.json();

            if (response.ok) {
              closeEditModal()
                showSwal("Updated", `${result.message}`, "success", true);
            } else {
                showSwal("Error", `${result.message}`, "error");
            }
        } catch (err) {
            showSwal("Error", "Network connection error", "error");
        }
    });

    /**
     * ORDER LOGIC
     */
     async function handlePlaceOrder() {
        // 1. Capture the selected Address ID
        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked')?.value;
        
        // 2. Capture the selected Payment Method
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

        // Validation
        if (!selectedAddress) {
            return showSwal("Notice", "Please select a shipping address", "info");
        }
        if (!paymentMethod) {
            return showSwal("Notice", "Please select a payment method", "info");
        }

        try {
            // Show a loading state (Optional but recommended)
            Swal.fire({
                title: 'Processing Order...',
                text: 'Please do not refresh the page',
                background: '#12141a',
                color: '#ffffff',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // 3. Perform POST request to /place-order
            const response = await fetch('/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    addressId: selectedAddress,
                    paymentMethod: paymentMethod
                })
            });

            const result = await response.json();

            if (response.ok) {
                // Success: Redirect to a success page or show message
                showSwal("Success!", result.message || "Your order has been placed.", "success");
                
                // Usually, you'd redirect after a short delay:
                setTimeout(() => {
                    window.location.href = `/success/${result.order.orderId}`;
                }, 2000);
            } else {
                // Error from backend (e.g., out of stock, invalid address)
                showSwal("Order Failed", result.message || "Something went wrong", "error");
            }
        } catch (err) {
            console.error(err);
            showSwal("Error", "A network error occurred. Please try again.", "error");
        }
    }

    function applyCoupon() {
      const code = document.getElementById('couponCode').value;
      if(!code) return showSwal("Missing Code", "Please enter a coupon code", "warning");
      showSwal("Coupon Applied", "Validating your discount code...", "info");
    }
</script>