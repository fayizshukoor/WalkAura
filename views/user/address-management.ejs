<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Address Management | WalkAura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease-out; }
        .modal-active .modal-content { transform: scale(1); }
        .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 500; display: none; }
        .input-error { border-color: #ef4444 !important; }
        .input-readonly { background-color: #1a1a1a; color: #9ca3af; cursor: not-allowed; border-color: #374151; }
        
        /* Dark Theme Swal Customization */
        .swal2-popup { background: #111 !important; color: #fff !important; border: 1px solid #333 !important; border-radius: 1.25rem !important; }
        .swal2-title, .swal2-html-container { color: #fff !important; }
        .swal2-confirm { background-color: #5c56f6 !important; box-shadow: 0 4px 10px rgba(92, 86, 246, 0.3) !important; }

        /* Checkbox Styling */
        .custom-checkbox {
            accent-color: #5c56f6;
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-black text-white font-sans antialiased">

    <div class="pt-20 min-h-screen flex flex-col">
        <div class="flex flex-col md:flex-row flex-1">
            <%- include("../partials/sidebar") %>

            <main class="flex-1 p-6 md:p-10 lg:p-12 bg-black">
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-10">
                        <h1 class="text-3xl font-bold tracking-tight text-white">Address Management</h1>
                        <button onclick="toggleModal('addAddressModal')" class="flex items-center gap-2 px-5 py-2.5 bg-[#5c56f6] hover:bg-[#4a44e0] text-white text-sm font-bold rounded-lg transition-all shadow-lg shadow-indigo-500/20">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                            Add New Address
                        </button>
                    </div>

                    <div id="address-list" class="space-y-4">
                        <% if (typeof locals.addresses !== "undefined" && addresses.length > 0) { %>
                            <% addresses.forEach(address => { %>
                                <div id="address-card-<%= address._id %>" class="bg-[#111] border border-gray-800/60 rounded-xl p-6 flex items-center justify-between group hover:border-gray-700 transition-all">
                                    <div class="flex items-start gap-5">
                                        <div class="w-12 h-12 rounded-lg bg-[#1a1a1a] border border-gray-800 flex items-center justify-center shrink-0">
                                            <span class="material-symbols-outlined <%= address.isDefault ? 'text-[#5c56f6]' : 'text-gray-400' %> text-[22px]">
                                                <%= address.isDefault ? 'stars' : 'home' %>
                                            </span>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h3 class="text-white font-bold text-base"><%= address.fullName %></h3>
                                                <% if (address.isDefault) { %>
                                                    <span class="bg-[#5c56f6]/10 text-[#5c56f6] text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border border-[#5c56f6]/20">Default</span>
                                                <% } %>
                                            </div>
                                            <p class="text-gray-400 text-sm leading-relaxed">
                                                <%= address.streetAddress %><br>
                                                <%= address.city %>, <%= address.state %> - <%= address.pincode %><br>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button class="text-gray-500 hover:text-white transition-colors" data-address='<%- JSON.stringify(address) %>' onclick="handleEditClick(this)">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button onclick="handleDeleteClick('<%= address._id %>')" class="text-gray-500 hover:text-red-500 transition-colors">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </div>
                                </div>
                            <% }) %>
                    
                            <div class="flex justify-center items-center gap-2 mt-10">
                                <% if (currentPage > 1) { %>
                                    <a href="?page=<%= currentPage - 1 %>" class="w-10 h-10 flex items-center justify-center rounded-lg bg-[#111] border border-gray-800 text-gray-400 hover:border-[#5c56f6] hover:text-white transition-all">
                                        <span class="material-symbols-outlined">chevron_left</span>
                                    </a>
                                <% } %>
                    
                                <% for(let i = 1; i <= totalPages; i++) { %>
                                    <a href="?page=<%= i %>" 
                                       class="w-10 h-10 flex items-center justify-center rounded-lg border transition-all font-bold text-sm
                                       <%= i === currentPage ? 'bg-[#5c56f6] border-[#5c56f6] text-white' : 'bg-[#111] border-gray-800 text-gray-400 hover:border-gray-600' %>">
                                        <%= i %>
                                    </a>
                                <% } %>
                    
                                <% if (currentPage < totalPages) { %>
                                    <a href="?page=<%= currentPage + 1 %>" class="w-10 h-10 flex items-center justify-center rounded-lg bg-[#111] border border-gray-800 text-gray-400 hover:border-[#5c56f6] hover:text-white transition-all">
                                        <span class="material-symbols-outlined">chevron_right</span>
                                    </a>
                                <% } %>
                            </div>
                    
                        <% } else { %>
                            <div id="no-addresses" class="flex flex-col items-center justify-center py-20 border border-dashed border-gray-800 rounded-2xl bg-[#080808]">
                                <span class="material-symbols-outlined text-gray-700 text-6xl mb-4">location_off</span>
                                <p class="text-gray-500 font-medium">No saved addresses found</p>
                            </div>
                        <% } %>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <div id="addAddressModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('addAddressModal')"></div>
        <div class="modal-content relative bg-[#111] border border-gray-800 w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Add New Address</h2>
                <button onclick="toggleModal('addAddressModal')" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="addAddressForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Full Name</label>
                        <input type="text" name="fullName" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_fullName"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Phone</label>
                        <input type="tel" name="phone" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_phone"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pincode</label>
                        <input type="text" name="pincode" id="add_pincode" maxlength="6" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p id="add_pincode_status" class="text-[10px] text-indigo-400 mt-1 hidden animate-pulse">Validating pincode...</p>
                        <p class="error-message" id="err_pincode"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Street Address</label>
                        <input type="text" name="streetAddress" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_streetAddress"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">City</label>
                        <input type="text" name="city" id="add_city" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">State</label>
                        <input type="text" name="state" id="add_state" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                    </div>
                    <div class="md:col-span-2 flex items-center gap-3 mt-2">
                        <input type="checkbox" name="isDefault" id="add_isDefault" class="custom-checkbox">
                        <label for="add_isDefault" class="text-sm text-gray-300 font-medium cursor-pointer">Set as default address</label>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" onclick="toggleModal('addAddressModal')" class="flex-1 px-4 py-3 border border-gray-800 text-gray-400 rounded-xl font-bold hover:bg-gray-900 transition-colors">Cancel</button>
                    <button type="submit" id="addSubmitBtn" class="flex-1 px-4 py-3 bg-[#5c56f6] text-white rounded-xl font-bold hover:bg-[#4a44e0] transition-all">Save Address</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editAddressModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('editAddressModal')"></div>
        <div class="modal-content relative bg-[#111] border border-gray-800 w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Edit Address</h2>
                <button onclick="toggleModal('editAddressModal')" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="editAddressForm" class="p-6">
                <input type="hidden" name="addressId" id="edit_addressId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Full Name</label>
                        <input type="text" id="edit_fullName" name="fullName" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_fullName"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Phone</label>
                        <input type="tel" id="edit_phone" name="phone" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_phone"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pincode</label>
                        <input type="text" id="edit_pincode" name="pincode" maxlength="6" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p id="edit_pincode_status" class="text-[10px] text-indigo-400 mt-1 hidden animate-pulse">Validating pincode...</p>
                        <p class="error-message" id="err_edit_pincode"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Street Address</label>
                        <input type="text" id="edit_streetAddress" name="streetAddress" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_streetAddress"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">City</label>
                        <input type="text" id="edit_city" name="city" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">State</label>
                        <input type="text" id="edit_state" name="state" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                    </div>
                    <div class="md:col-span-2 flex items-center gap-3 mt-2">
                        <input type="checkbox" name="isDefault" id="edit_isDefault" class="custom-checkbox">
                        <label for="edit_isDefault" class="text-sm text-gray-300 font-medium cursor-pointer">Set as default address</label>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" onclick="toggleModal('editAddressModal')" class="flex-1 px-4 py-3 border border-gray-800 text-gray-400 rounded-xl font-bold hover:bg-gray-900 transition-colors">Cancel</button>
                    <button type="submit" id="editSubmitBtn" class="flex-1 px-4 py-3 bg-[#5c56f6] text-white rounded-xl font-bold hover:bg-[#4a44e0] transition-all">Update Address</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Modal Helper ---
        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const isOpening = modal.classList.contains('hidden');
            if (isOpening) {
                const form = modal.querySelector('form');
                if (form && modalId === 'addAddressModal') {
                    form.reset();
                    // Ensure checkbox is unchecked by default on reset
                    if(form.isDefault) form.isDefault.checked = false;
                }
                modal.querySelectorAll('.error-message').forEach(m => m.style.display = 'none');
                modal.querySelectorAll('input').forEach(i => i.classList.remove('input-error'));
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('modal-active'), 10);
                document.body.style.overflow = 'hidden';
            } else {
                modal.classList.remove('modal-active');
                setTimeout(() => modal.classList.add('hidden'), 200);
                document.body.style.overflow = 'auto';
            }
        }

        // --- Pincode Autofill & Clearing Logic ---
        async function fetchPincode(pincode, cityInp, stateInp, statusEl) {
            if (pincode.length < 6) {
                cityInp.value = "";
                stateInp.value = "";
                statusEl.classList.add('hidden');
                return;
            }

            statusEl.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                const data = await response.json();
                statusEl.classList.add('hidden');
                
                if (data[0].Status === "Success") {
                    cityInp.value = data[0].PostOffice[0].District;
                    stateInp.value = data[0].PostOffice[0].State;
                } else {
                    cityInp.value = "";
                    stateInp.value = "";
                }
            } catch (err) { 
                statusEl.classList.add('hidden'); 
            }
        }

        document.getElementById('add_pincode').addEventListener('input', e => {
            fetchPincode(e.target.value, document.getElementById('add_city'), document.getElementById('add_state'), document.getElementById('add_pincode_status'));
        });
        
        document.getElementById('edit_pincode').addEventListener('input', e => {
            fetchPincode(e.target.value, document.getElementById('edit_city'), document.getElementById('edit_state'), document.getElementById('edit_pincode_status'));
        });

        // --- Add Address ---
        document.getElementById('addAddressForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateAddressForm(this)) return;
            
            const btn = document.getElementById('addSubmitBtn');
            btn.disabled = true;
            
            // Explicitly capture checkbox value
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.isDefault = this.isDefault.checked; 

            try {
                const response = await fetch('/addresses/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    toggleModal('addAddressModal');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Address has been saved.',
                        confirmButtonText: 'OK'
                    }).then(() => window.location.reload());
                } else {
                    const err = await response.json();
                    Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'Could not save address' });
                    btn.disabled = false;
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Network Error', text: 'Please try again later' });
                btn.disabled = false;
            }
        });

        // --- Edit Address ---
        function handleEditClick(button) {
            const address = JSON.parse(button.dataset.address);
            toggleModal('editAddressModal');
            document.getElementById('edit_addressId').value = address._id;
            document.getElementById('edit_fullName').value = address.fullName;
            document.getElementById('edit_phone').value = address.phone;
            document.getElementById('edit_pincode').value = address.pincode;
            document.getElementById('edit_streetAddress').value = address.streetAddress;
            document.getElementById('edit_city').value = address.city;
            document.getElementById('edit_state').value = address.state;
            document.getElementById('edit_isDefault').checked = address.isDefault || false;
        }

        document.getElementById('editAddressForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateAddressForm(this, 'edit_')) return;
            
            const btn = document.getElementById('editSubmitBtn');
            const addressId = document.getElementById('edit_addressId').value;
            btn.disabled = true;

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.isDefault = this.isDefault.checked;

            try {
                const response = await fetch(`/addresses/${addressId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    toggleModal('editAddressModal');
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: 'Address details updated successfully.',
                        confirmButtonText: 'OK'
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire({ icon: 'error', title: 'Update Failed', text: 'Check your data and try again.' });
                    btn.disabled = false;
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Network Error', text: 'Please try again later' });
                btn.disabled = false;
            }
        });

        // --- Delete Address ---
        async function handleDeleteClick(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#5c56f6',
                cancelButtonColor: '#333',
                confirmButtonText: 'Yes, delete it!',
                background: '#111',
                color: '#fff'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/addresses/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Address has been removed.',
                            confirmButtonText: 'OK'
                        }).then(() => window.location.reload());
                    } else {
                        Swal.fire({ icon: 'error', title: 'Oops...', text: 'Something went wrong while deleting.' });
                    }
                } catch (err) {
                    Swal.fire({ icon: 'error', title: 'Network Error', text: 'Connection failed.' });
                }
            }
        }

        // --- Form Validation ---
        function validateAddressForm(form, prefix = '') {
            let isValid = true;
            const fields = ['fullName', 'phone', 'pincode', 'streetAddress'];
            
            fields.forEach(f => {
                const input = form[f];
                const error = document.getElementById(`err_${prefix}${f}`);
                if (!input.value.trim()) {
                    input.classList.add('input-error');
                    if (error) { error.innerText = "This field is required"; error.style.display = 'block'; }
                    isValid = false;
                } else {
                    input.classList.remove('input-error');
                    if (error) error.style.display = 'none';
                }
            });

            if (isValid) {
                const phone = form.phone.value.trim();
                const pin = form.pincode.value.trim();
                if (!/^\d{10}$/.test(phone)) {
                    const e = document.getElementById(`err_${prefix}phone`);
                    e.innerText = "Enter valid 10-digit number"; e.style.display = 'block';
                    isValid = false;
                }
                if (!/^\d{6}$/.test(pin)) {
                    const e = document.getElementById(`err_${prefix}pincode`);
                    e.innerText = "Enter valid 6-digit pincode"; e.style.display = 'block';
                    isValid = false;
                }
                if (!form.city.value || !form.state.value) {
                    const e = document.getElementById(`err_${prefix}pincode`);
                    e.innerText = "Invalid pincode or location not found"; e.style.display = 'block';
                    isValid = false;
                }
            }
            return isValid;
        }
    </script>
</body>
</html>