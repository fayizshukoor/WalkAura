<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Address Management | WalkAura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease-out; }
        .modal-active .modal-content { transform: scale(1); }
        .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 500; display: none; }
        .input-error { border-color: #ef4444 !important; }
        /* Style for readonly fields to look distinct */
        .input-readonly { background-color: #1a1a1a; color: #9ca3af; cursor: not-allowed; border-color: #374151; }
    </style>
</head>
<body class="bg-black text-white font-sans antialiased">
    
    <div class="pt-20 min-h-screen flex flex-col">
        <div class="flex flex-col md:flex-row flex-1">
            <%- include("../partials/sidebar") %>

            <main class="flex-1 p-6 md:p-10 lg:p-12 bg-black">
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-10">
                        <h1 class="text-3xl font-bold tracking-tight text-white">Address Management</h1>
                        <button onclick="toggleModal('addAddressModal')" class="flex items-center gap-2 px-5 py-2.5 bg-[#5c56f6] hover:bg-[#4a44e0] text-white text-sm font-bold rounded-lg transition-all shadow-lg shadow-indigo-500/20">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                            Add New Address
                        </button>
                    </div>

                    <%- include('../partials/alerts') %>

                    <div class="space-y-4">
                        <% if (typeof locals.addresses !== "undefined" && addresses.length > 0) { %>
                            <% addresses.forEach(address => { %>
                                <div class="bg-[#111] border border-gray-800/60 rounded-xl p-6 flex items-center justify-between group hover:border-gray-700 transition-all">
                                    <div class="flex items-start gap-5">
                                        <div class="w-12 h-12 rounded-lg bg-[#1a1a1a] border border-gray-800 flex items-center justify-center shrink-0">
                                            <span class="material-symbols-outlined text-gray-400 text-[22px]">home</span>
                                        </div>
                                        <div>
                                            <h3 class="text-white font-bold text-base mb-1"><%= address.fullName %></h3>
                                            <p class="text-gray-400 text-sm leading-relaxed">
                                                <%= address.streetAddress%><br>
                                                <%= address.city %>, <%= address.state %> - <%= address.pincode %><br>
                                                <%= address.country %>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button class="text-gray-500 hover:text-white transition-colors" data-address='<%- JSON.stringify(address) %>' onclick="handleEditClick(this)">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button onclick="openDeleteModal('<%= address._id %>')" class="text-gray-500 hover:text-red-500 transition-colors">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="flex flex-col items-center justify-center py-20 border border-dashed border-gray-800 rounded-2xl bg-[#080808]">
                                <span class="material-symbols-outlined text-gray-700 text-6xl mb-4">location_off</span>
                                <p class="text-gray-500 font-medium">No saved addresses found</p>
                                <p class="text-gray-600 text-sm">Add an address to speed up your checkout process.</p>
                            </div>
                        <% } %>
                    </div>

                    <% if(totalPages > 1){ %>
                        <div class="flex justify-center gap-2 mt-10">
                           
                            <% for (let i = 1; i <= totalPages; i++) { %>
                                <a href="?page=<%= i %>" class="px-4 py-2 rounded-lg border <%= currentPage === i ? 'bg-[#5c56f6] text-white border-[#5c56f6]' : 'bg-[#1a1a1a] border-gray-800 hover:bg-gray-800' %>"><%= i %></a>
                            <% } %>
                        </div>
                    <% } %>
                    <div class="mt-16 border-t border-gray-900"></div>
                </div>
            </main>
        </div>
    </div>

    <div id="addAddressModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('addAddressModal')"></div>
        <div class="modal-content relative bg-[#111] border border-gray-800 w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Add New Address</h2>
                <button onclick="toggleModal('addAddressModal')" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form action="/addresses/add" method="POST" class="p-6" onsubmit="return validateAddressForm(this)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Full Name</label>
                        <input type="text" name="fullName" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_fullName"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Phone</label>
                        <input type="tel" name="phone" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_phone"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pincode</label>
                        <input type="text" name="pincode" id="add_pincode" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p id="add_pincode_status" class="text-[10px] text-indigo-400 mt-1 hidden animate-pulse">Validating pincode...</p>
                        <p class="error-message" id="err_pincode"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Street Address</label>
                        <input type="text" name="streetAddress" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_streetAddress"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">City</label>
                        <input type="text" name="city" id="add_city" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                        <p class="error-message" id="err_city"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">State</label>
                        <input type="text" name="state" id="add_state" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                        <p class="error-message" id="err_state"></p>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" onclick="toggleModal('addAddressModal')" class="flex-1 px-4 py-3 border border-gray-800 text-gray-400 rounded-xl font-bold hover:bg-gray-900 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-[#5c56f6] text-white rounded-xl font-bold hover:bg-[#4a44e0] transition-all shadow-lg shadow-indigo-500/20">Save Address</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editAddressModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('editAddressModal')"></div>
        <div class="modal-content relative bg-[#111] border border-gray-800 w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Edit Address</h2>
                <button onclick="toggleModal('editAddressModal')" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="editAddressForm" method="POST" class="p-6" onsubmit="return validateAddressForm(this, 'edit_')">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Full Name</label>
                        <input type="text" id="edit_fullName" name="fullName" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_fullName"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Phone</label>
                        <input type="tel" id="edit_phone" name="phone" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_phone"></p>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pincode</label>
                        <input type="text" id="edit_pincode" name="pincode" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p id="edit_pincode_status" class="text-[10px] text-indigo-400 mt-1 hidden animate-pulse">Validating pincode...</p>
                        <p class="error-message" id="err_edit_pincode"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Street Address</label>
                        <input type="text" id="edit_streetAddress" name="streetAddress" class="w-full bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5c56f6] transition-colors">
                        <p class="error-message" id="err_edit_streetAddress"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">City</label>
                        <input type="text" id="edit_city" name="city" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                        <p class="error-message" id="err_edit_city"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">State</label>
                        <input type="text" id="edit_state" name="state" readonly class="w-full input-readonly rounded-lg px-4 py-2.5 focus:outline-none">
                        <p class="error-message" id="err_edit_state"></p>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" onclick="toggleModal('editAddressModal')" class="flex-1 px-4 py-3 border border-gray-800 text-gray-400 rounded-xl font-bold hover:bg-gray-900 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-[#5c56f6] text-white rounded-xl font-bold hover:bg-[#4a44e0] transition-all shadow-lg shadow-indigo-500/20">Update Address</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteAddressModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('deleteAddressModal')"></div>
        <div class="modal-content relative bg-[#111] border border-gray-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="px-6 py-4 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white">Delete Address</h2>
            </div>
            <div class="p-6 text-gray-300">
                <p class="mb-6">Are you sure you want to delete this address? This action cannot be undone.</p>
                <div class="flex gap-4">
                    <button type="button" onclick="toggleModal('deleteAddressModal')" class="flex-1 px-4 py-3 border border-gray-800 text-gray-400 rounded-xl font-bold hover:bg-gray-900">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Modal Logic ---
        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            const errorMessages = modal.querySelectorAll('.error-message');
            const errorInputs = modal.querySelectorAll('input');
            const statusTexts = modal.querySelectorAll('[id$="_status"]');

            errorMessages.forEach(m => m.style.display = 'none');
            errorInputs.forEach(i => i.classList.remove('input-error'));
            statusTexts.forEach(s => s.classList.add('hidden'));

            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('modal-active'), 10);
                document.body.style.overflow = 'hidden';
            } else {
                modal.classList.remove('modal-active');
                setTimeout(() => modal.classList.add('hidden'), 200);
                document.body.style.overflow = 'auto';
            }
        }

        function handleEditClick(button) {
            const address = JSON.parse(button.dataset.address);
            openEditModal(address);
        }

        function openEditModal(address) {
            const form = document.getElementById('editAddressForm');
            document.getElementById('edit_fullName').value = address.fullName || '';
            document.getElementById('edit_phone').value = address.phone || '';
            document.getElementById('edit_pincode').value = address.pincode || '';
            document.getElementById('edit_streetAddress').value = address.streetAddress || '';
            document.getElementById('edit_city').value = address.city || '';
            document.getElementById('edit_state').value = address.state || '';
            form.action = `/addresses/${address._id}/edit`;
            toggleModal('editAddressModal');
        }

        let deleteAddressId = null;
        document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
            if (!deleteAddressId) return;
            window.location.href = `/addresses/delete/${deleteAddressId}`;
        });

        function openDeleteModal(addressId) {
            deleteAddressId = addressId;
            toggleModal("deleteAddressModal");
        }

        // --- PINCODE & AUTOFILL LOGIC ---

        const addPincodeInput = document.getElementById('add_pincode');
        const editPincodeInput = document.getElementById('edit_pincode');

        // Event listener for Add Modal
        addPincodeInput.addEventListener('input', function() {
            handlePincodeInput(this, '', 'add_city', 'add_state', 'add_pincode_status');
        });

        // Event listener for Edit Modal
        editPincodeInput.addEventListener('input', function() {
            handlePincodeInput(this, 'edit_', 'edit_city', 'edit_state', 'edit_pincode_status');
        });

        function handlePincodeInput(input, prefix, cityId, stateId, statusId) {
            const val = input.value.trim();
            const cityInput = document.getElementById(cityId);
            const stateInput = document.getElementById(stateId);
            const statusLabel = document.getElementById(statusId);
            const errorLabel = document.getElementById(`err_${prefix}pincode`);

            // Clear city/state if pincode is changed/incomplete
            if (val.length !== 6) {
                cityInput.value = "";
                stateInput.value = "";
                statusLabel.classList.add('hidden');
                return;
            }

            // If 6 digits, validate and autofill
            validateAndFetchPincode(val, input, prefix, cityInput, stateInput, statusLabel, errorLabel);
        }

        async function validateAndFetchPincode(pincode, inputEl, prefix, cityEl, stateEl, statusEl, errorEl) {
            // Reset state
            statusEl.classList.remove('hidden');
            errorEl.style.display = 'none';
            inputEl.classList.remove('input-error');

            try {
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                const data = await response.json();

                statusEl.classList.add('hidden');

                if (data[0].Status === "Success") {
                    const postOffice = data[0].PostOffice[0];
                    cityEl.value = postOffice.District;
                    stateEl.value = postOffice.State;
                } else {
                    cityEl.value = "";
                    stateEl.value = "";
                    showError(inputEl, errorEl, "Invalid pincode or area not found");
                }
            } catch (err) {
                statusEl.classList.add('hidden');
                showError(inputEl, errorEl, "Network error. Try again.");
            }
        }

        // --- FORM VALIDATION ---

        function validateAddressForm(form, prefix = '') {
            let isValid = true;
            const fields = ['fullName', 'phone', 'pincode', 'streetAddress', 'city', 'state'];
            
            fields.forEach(field => {
                const input = form[field];
                const errorDisplay = document.getElementById(`err_${prefix}${field}`);
                input.classList.remove('input-error');
                errorDisplay.style.display = 'none';

                if (!input.value.trim()) {
                    showError(input, errorDisplay, "This field is required");
                    isValid = false;
                }
            });

            if (isValid) {
                const phone = form.phone.value.trim();
                if (!/^\d{10}$/.test(phone)) {
                    showError(form.phone, document.getElementById(`err_${prefix}phone`), "Phone must be 10 digits");
                    isValid = false;
                }

                const pincode = form.pincode.value.trim();
                if (!/^\d{6}$/.test(pincode)) {
                    showError(form.pincode, document.getElementById(`err_${prefix}pincode`), "Pincode must be 6 digits");
                    isValid = false;
                }
            }

            return isValid;
        }

        function showError(input, errorElement, message) {
            input.classList.add('input-error');
            errorElement.innerText = message;
            errorElement.style.display = 'block';
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                ['addAddressModal', 'editAddressModal', 'deleteAddressModal'].forEach(id => {
                    const modal = document.getElementById(id);
                    if (modal && !modal.classList.contains('hidden')) toggleModal(id);
                });
            }
        });
    </script>
</body>
</html>