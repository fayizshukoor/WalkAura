<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Inter', sans-serif; }
    input:focus { border-color: #5c56f6 !important; }
    select:focus { border-color: #5c56f6 !important; }
    
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Pulse animation for return requests */
    @keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .return-pulse {
        animation: pulse-red 2s infinite;
    }
</style>

<main class="flex-grow pt-8 pb-20 px-4 sm:px-6 lg:px-8 bg-black min-h-screen text-gray-200 antialiased">
    <div class="max-w-[1250px] mx-auto space-y-8">
        
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-white">Order Management</h1>
                <p class="text-gray-500 text-sm mt-1">Manage and track customer orders, payments, and fulfillment status.</p>
            </div>
            <div class="text-right">
                <p class="text-gray-500 text-xs font-semibold uppercase tracking-widest">
                    Total Volume: <span class="text-[#5c56f6] ml-2"><%= pagination.totalOrders %> Orders</span>
                </p>
            </div>
        </div>

        <section class="bg-[#111111] border border-gray-800 rounded-2xl p-6 shadow-xl">
            <form action="/admin/orders" method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2 relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xl">search</span>
                    <input type="text" name="search" placeholder="Search Order ID, Name, Phone or Email..." value="<%= filters.search %>"
                        class="w-full bg-black border border-gray-800 rounded-xl py-2.5 pl-10 pr-4 text-white text-sm focus:outline-none transition-colors">
                </div>

                <select name="status" onchange="this.form.submit()" class="bg-black border border-gray-800 rounded-xl py-2.5 px-4 text-white text-sm focus:outline-none cursor-pointer transition-colors">
                    <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Status</option>
                    <option value="PENDING" <%= filters.status === 'PENDING' ? 'selected' : '' %>>Pending</option>
                    <option value="SHIPPED" <%= filters.status === 'SHIPPED' ? 'selected' : '' %>>Shipped</option>
                    <option value="DELIVERED" <%= filters.status === 'DELIVERED' ? 'selected' : '' %>>Delivered</option>
                    <option value="CANCELLED" <%= filters.status === 'CANCELLED' ? 'selected' : '' %>>Cancelled</option>
                </select>

                <select name="sort" onchange="this.form.submit()" class="bg-black border border-gray-800 rounded-xl py-2.5 px-4 text-white text-sm focus:outline-none cursor-pointer transition-colors">
                    <option value="newest" <%= filters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                    <option value="oldest" <%= filters.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                    <option value="amount_high" <%= filters.sort === 'amount_high' ? 'selected' : '' %>>Price: High</option>
                    <option value="amount_low" <%= filters.sort === 'amount_low' ? 'selected' : '' %>>Price: Low</option>
                </select>
            </form>
        </section>

        <section class="bg-[#111111] border border-gray-800 rounded-2xl overflow-hidden shadow-xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="text-gray-500 border-b border-gray-800 bg-white/[0.01]">
                        <tr>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Order ID</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Date</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Customer</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider text-right">Total Price</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider text-center">Payment</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider text-center">Status Control</th>
                            <th class="p-5 font-semibold uppercase text-[10px] tracking-wider text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-900">
                        <% if (orders.length === 0) { %>
                            <tr><td colspan="7" class="p-20 text-center text-gray-500 font-medium">No orders found</td></tr>
                        <% } else { %>
                            <% orders.forEach(order => { %>
                                <tr class="hover:bg-white/[0.02] transition-colors">
                                    <td class="p-5">
                                        <div class="flex items-center gap-3">
                                            <span class="text-white font-semibold">#<%= order.orderId %></span>
                                            <% if (order.hasReturnRequest) { %>
                                                <span class="flex h-2 w-2 rounded-full bg-red-500 return-pulse" title="Return Requested"></span>
                                            <% } %>
                                        </div>
                                    </td>
                                    <td class="p-5">
                                        <div class="flex flex-col">
                                            <span class="text-white text-sm font-medium">
                                                <%= new Date(order.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) %>
                                            </span>
                                            <span class="text-[12px] text-gray-400">
                                                <%= new Date(order.createdAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) %>
                                            </span>
                                        </div>
                                    </td>
                                    <td class="p-5">
                                        <div class="flex flex-col">
                                            <span class="text-white font-medium"><%= order.user.name %></span>
                                            <span class="text-[12px] text-gray-400"><%= order.user.email %></span>
                                        </div>
                                    </td>
                                    <td class="p-5 text-right">
                                        <span class="bg-[#5c56f6]/10 text-white border border-[#5c56f6]/20 px-3 py-1.5 rounded-lg font-mono font-bold text-sm tracking-tight shadow-[0_0_15px_rgba(92,86,246,0.1)]">
                                            â‚¹<%= order.pricing.totalAmount.toLocaleString('en-IN') %>
                                        </span>
                                    </td>   
                                    <td class="p-5 text-center">
                                        <% 
                                            const method = (order.payment.method || '').toUpperCase();
                                            const mClass = method === 'RAZORPAY' ? 'text-blue-400 bg-blue-400/10 border-blue-400/20' : 
                                                           method === 'WALLET' ? 'text-purple-400 bg-purple-400/10 border-purple-400/20' : 
                                                           method === 'COD' ? 'text-amber-400 bg-amber-400/10 border-amber-400/20' : 
                                                           'text-gray-400 bg-gray-400/10 border-gray-400/20';
                                        %>
                                        <span class="<%= mClass %> px-2.5 py-1 rounded text-[10px] font-bold tracking-wider border"><%= method %></span>
                                    </td>
                                    <td class="p-5 text-center">
                                        <% 
                                            const status = order.orderStatus;
                                            const sColors = {
                                                'PENDING': 'border-yellow-500/30 text-yellow-500 bg-yellow-500/5',
                                                'SHIPPED': 'border-blue-500/30 text-blue-500 bg-blue-500/5',
                                                'OUT_FOR_DELIVERY': 'border-indigo-500/30 text-indigo-500 bg-indigo-500/5',
                                                'DELIVERED': 'border-green-500/30 text-green-500 bg-green-500/5',
                                                'CANCELLED': 'border-red-500/30 text-red-500 bg-red-500/5',
                                                'RETURNED': 'border-purple-500/30 text-purple-500 bg-purple-500/5'
                                            };
                                            const allowedSteps = {
                                                'PENDING': ['SHIPPED', 'CANCELLED'],
                                                'SHIPPED': ['OUT_FOR_DELIVERY'],
                                                'OUT_FOR_DELIVERY': ['DELIVERED'],
                                                'DELIVERED': [], 'CANCELLED': [], 'RETURNED': []
                                            };
                                            const options = allowedSteps[status] || [];
                                        %>

                                        <% if (options.length > 0) { %>
                                            <select 
                                                onchange="handleStatusChange('<%= order.orderId %>', this.value, '<%= status %>')"
                                                class="bg-black border <%= sColors[status] %> rounded-lg py-1.5 px-3 text-[11px] font-bold uppercase tracking-wider outline-none cursor-pointer hover:bg-white/10 transition-all"
                                            >
                                                <option value="" selected disabled><%= status %></option>
                                                <% options.forEach(opt => { %>
                                                    <option value="<%= opt %>" class="bg-[#111] text-white"><%= opt %></option>
                                                <% }) %>
                                            </select>
                                        <% } else { %>
                                            <span class="<%= sColors[status] %> border px-3 py-1.5 rounded-lg text-[11px] font-bold uppercase tracking-wider">
                                                <%= status %>
                                            </span>
                                        <% } %>
                                    </td>
                                    <td class="p-5 text-center">
                                        <a href="/admin/orders/<%= order.orderId %>" 
                                           class="relative group flex items-center justify-center transition-all" 
                                           title="<%= order.hasReturnRequest ? 'Action Required: Return Request' : 'View Details' %>">
                                            
                                            <% if (order.hasReturnRequest) { %>
                                                <div class="flex items-center gap-1 bg-orange-500/10 text-orange-500 border border-orange-500/20 px-2 py-1 rounded-md hover:bg-orange-500 hover:text-white transition-all">
                                                    <span class="material-symbols-outlined text-[18px]">assignment_return</span>
                                                    <span class="text-[10px] font-black uppercase">Review</span>
                                                </div>
                                            <% } else { %>
                                                <span class="material-symbols-outlined text-[22px] text-gray-400 group-hover:text-[#5c56f6]">visibility</span>
                                            <% } %>
                                        </a>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <div class="p-5 border-t border-gray-800 flex justify-center items-center gap-2 bg-white/[0.01]">
                <% if (pagination.totalPages > 1) { %>
                    <a href="?page=<%= pagination.currentPage - 1 %>&search=<%= filters.search %>&status=<%= filters.status %>&sort=<%= filters.sort %>" 
                       class="text-gray-500 hover:text-white px-3 text-sm <%= pagination.currentPage === 1 ? 'pointer-events-none opacity-20' : '' %>">
                        Prev
                    </a>
                    <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                        <a href="?page=<%= i %>&search=<%= filters.search %>&status=<%= filters.status %>&sort=<%= filters.sort %>" 
                           class="w-8 h-8 flex items-center justify-center rounded-lg text-xs font-bold transition-colors <%= i === pagination.currentPage ? 'bg-[#5c56f6] text-white' : 'text-gray-500 hover:bg-white/5' %>">
                            <%= i %>
                        </a>
                    <% } %>
                    <a href="?page=<%= pagination.currentPage + 1 %>&search=<%= filters.search %>&status=<%= filters.status %>&sort=<%= filters.sort %>" 
                       class="text-gray-500 hover:text-white px-3 text-sm <%= pagination.currentPage === pagination.totalPages ? 'pointer-events-none opacity-20' : '' %>">
                        Next
                    </a>
                <% } %>
            </div>
        </section>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
async function handleStatusChange(orderId, newStatus, currentStatus) {
    const result = await Swal.fire({
        title: 'Update Status?',
        text: `Move Order #${orderId} from ${currentStatus} to ${newStatus}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#5c56f6',
        cancelButtonColor: '#1f2937',
        confirmButtonText: 'Confirm Update',
        background: '#111',
        color: '#fff'
    });

    if (result.isConfirmed) {
        try {
            Swal.fire({
                title: 'Processing...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); },
                background: '#111',
                color: '#fff'
            });

            const response = await fetch(`/admin/orders/${orderId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (data.success) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: data.message,
                    timer: 1500,
                    showConfirmButton: false,
                    background: '#111',
                    color: '#fff'
                });
                window.location.reload();
            } else {
                throw new Error(data.message || 'Something went wrong');
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Update Failed',
                text: error.message,
                background: '#111',
                color: '#fff'
            }).then(() => {
                window.location.reload(); 
            });
        }
    } else {
        window.location.reload();
    }
}
</script>