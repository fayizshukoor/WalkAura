<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WalkAura | Customer Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      body {
        background-color: #000;
        color: #fff;
        font-family: sans-serif;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 300, "GRAD" 0, "opsz" 24;
      }

      /* Nav Active Styles */
      .nav-item.active {
        background-color: #111;
        color: #fff;
      }
      .nav-item.active .material-symbols-outlined {
        color: #5c56f6;
        font-variation-settings: "FILL" 1;
      }

      /* Custom Toggle Switch Styles */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #5c56f6;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #5c56f6;
      }

      /* --- Custom SweetAlert2 Styling to match WalkAura --- */
      .walkaura-swal-popup {
        border-radius: 24px !important;
        background: #111 !important;
        border: 1px solid #222 !important;
        padding: 2rem !important;
      }
      .walkaura-swal-title {
        color: #fff !important;
        font-size: 1.5rem !important;
        font-weight: 700 !important;
      }
      .walkaura-swal-content {
        color: #9ca3af !important; /* gray-400 */
      }
      .walkaura-swal-confirm {
        border-radius: 12px !important;
        padding: 12px 30px !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
      }
      .walkaura-swal-cancel {
        border-radius: 12px !important;
        background: #1f2937 !important; /* gray-800 */
        padding: 12px 30px !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
      }
    </style>
  </head>
  <body class="antialiased">
    <div class="flex min-h-screen w-full">
      <%- include('.././partials/adminsidebar') %>

      <main class="flex-1 p-6 md:p-10 w-full">
        <div class="max-w-7xl mx-auto">
          <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8"
          >
            <div>
              <h1 class="text-3xl font-bold">Customer Management</h1>
              <p class="text-gray-500 text-sm mt-1">
                Manage your customer accounts and view their status.
              </p>
            </div>

            <form
              action="/admin/customers"
              method="GET"
              class="flex w-full md:w-auto gap-2"
            >
              <div class="relative flex-1 md:w-80">
                <span
                  class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xl"
                >
                  search
                </span>

                <input
                  type="text"
                  name="search"
                  value="<%= search || '' %>"
                  placeholder="Search by name, email, phone..."
                  class="w-full bg-[#111] border border-gray-800 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-[#5c56f6] transition-colors"
                />
              </div>

              <button
                type="submit"
                class="bg-[#5c56f6] hover:bg-[#4a44e0] text-white px-6 py-2.5 rounded-xl text-sm font-bold transition-all"
              >
                Search
              </button>

              <% if (search) { %>
              <a
                href="/admin/customers"
                class="px-5 py-2.5 rounded-xl text-sm font-bold bg-gray-800 hover:bg-gray-700 transition-all flex items-center"
              >
                Clear
              </a>
              <% } %>
            </form>
          </div>

          <div
            class="bg-[#111] rounded-2xl border border-gray-800 overflow-hidden"
          >
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="text-gray-500 border-b border-gray-800">
                  <tr>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Customer ID</th>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Name</th>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Email</th>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Phone</th>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider">Status</th>
                    <th class="p-5 font-semibold uppercase text-[10px] tracking-wider text-center">Actions</th>
                  </tr>
                </thead>

                <tbody class="divide-y divide-gray-900">
                  <% customers.forEach(customer => { %>
                  <tr class="hover:bg-white/[0.02] transition-colors">
                    <td class="p-5 text-gray-400 font-mono">
                      <%= customer._id.toString().slice(-6).toUpperCase() %>
                    </td>
                    <td class="p-5 font-medium text-white"><%= customer.name %></td>
                    <td class="p-5 text-gray-400"><%= customer.email %></td>
                    <td class="p-5 text-gray-400"><%= customer.phone || "â€”" %></td>
                    <td class="p-5">
                      <% if (!customer.isBlocked) { %>
                      <span class="inline-flex px-2.5 py-0.5 rounded-full text-xs bg-green-500/10 text-green-500">
                        Active
                      </span>
                      <% } else { %>
                      <span class="inline-flex px-2.5 py-0.5 rounded-full text-xs bg-red-500/10 text-red-500">
                        Blocked
                      </span>
                      <% } %>
                    </td>
                    <td class="p-5 text-center">
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input 
                          type="checkbox" 
                          class="sr-only peer" 
                          <%= !customer.isBlocked ? "checked" : "" %>
                          onclick="confirmToggleStatus(event, '<%= customer._id %>', '<%= customer.isBlocked %>', '<%= customer.name %>')"
                        />
                        <div class="w-11 h-6 bg-gray-800 rounded-full peer peer-checked:bg-[#5c56f6] after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                      </label>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

            <div class="p-5 border-t border-gray-800 flex justify-center gap-2">
              <% for (let i = 1; i <= totalPages; i++) { %>
              <a
                href="?page=<%= i %>&search=<%= search %>"
                class="w-8 h-8 flex items-center justify-center rounded-full text-xs font-bold <%= i === currentPage ? 'bg-[#5c56f6] text-white' : 'text-gray-500 hover:bg-gray-800' %>"
              >
                <%= i %>
              </a>
              <% } %>
            </div>
          </div>
        </div>
      </main>
    </div>

<script>
  /**
   * Configures a reusable SweetAlert instance for WalkAura theme
   */
  const WalkAuraSwal = Swal.mixin({
    customClass: {
      popup: 'walkaura-swal-popup',
      title: 'walkaura-swal-title',
      htmlContainer: 'walkaura-swal-content',
      confirmButton: 'walkaura-swal-confirm',
      cancelButton: 'walkaura-swal-cancel'
    },
    background: '#111',
    color: '#fff',
    backdrop: `rgba(0,0,0,0.8) blur(4px)`
  });

  async function confirmToggleStatus(event, userId, isBlockedString, userName) {
    event.preventDefault();
    
    const isCurrentlyBlocked = isBlockedString === 'true';
    const actionName = isCurrentlyBlocked ? 'unblock' : 'block';
    const accentColor = isCurrentlyBlocked ? '#10b981' : '#ef4444'; // Green for unblock, Red for block

    const result = await WalkAuraSwal.fire({
      title: `${isCurrentlyBlocked ? 'Unblock' : 'Block'} User?`,
      text: `Are you sure you want to change the status of ${userName}?`,
      icon: 'warning',
      iconColor: accentColor,
      showCancelButton: true,
      confirmButtonText: `Yes, ${actionName}`,
      cancelButtonText: 'Cancel',
      confirmButtonColor: accentColor,
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/admin/customers/${userId}/toggle-status`, {
          method: "PATCH"
        });

        if (response.ok) {
          await WalkAuraSwal.fire({
            title: 'Success!',
            text: `${userName} has been ${isCurrentlyBlocked ? 'unblocked' : 'blocked'}.`,
            icon: 'success',
            iconColor: '#10b981',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          throw new Error();
        }
      } catch (error) {
        WalkAuraSwal.fire({
          title: 'Error!',
          text: 'Failed to update customer status.',
          icon: 'error',
          confirmButtonText: 'Try Again'
        });
      }
    }
  }
</script>
</body>
</html>